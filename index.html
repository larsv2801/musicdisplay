<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Spotify Now Playing</title>
<style>
    body{
        background-color: rgb(37, 37, 37);
        color:white;
        font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
        background-size:cover;
        width:100dvw;
        height:100dvh;
        padding:0;
        margin:0;
    }

    #bg {
    position: fixed;
    top:0;
    left:0;
    width:100%;
    height:100%;
    background-size: cover;
    background-position: center;
    filter: blur(90px) brightness(0.9);
    animation: turn 300s linear infinite;
    z-index: -1; /* achter content */
}

@keyframes turn {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
}


    button{
        position:fixed;
        left:50%;
        top:50%;
        transform: translate(-50%,-50%);
        width:30dvw;
        height:10dvw;
        border-radius:500px;
        font-size:2dvw;
        color:green;
        background-color: white;
        transition:0.5s;
    }
    button:hover{
        width:30dvw;
        height:10dvw;
        border-radius:500px;
        font-size:2dvw;
        color:green;
        background-color: rgb(233, 233, 233);
        transition:0.5s;
    }

    #nowPlaying{
        position:fixed;
        left:50%;
        top:50%;
        transform: translate(-50%,-50%);
        text-shadow: 0px 0px 15px rgb(163, 163, 163);
    }

    #nowPlaying img{
        width:35dvw;
        height:35dvw;
        border-radius:15px;
        transition: 0.3s;
    }
    #nowPlaying img:hover{
        width:35dvw;
        height:35dvw;
        border-radius:10px;
        transition: 0.3s;
    }

</style>
</head>
<body>

<div id="bg"></div>
<button id="loginBtn">Login met Spotify</button>
<div id="nowPlaying"></div>

<script>

// ====== Functies ======
function generateRandomString(length) {
    const chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";
    let result = "";
    for (let i = 0; i < length; i++) {
        result += chars.charAt(Math.floor(Math.random() * chars.length));
    }
    return result;
}

async function sha256(plain) {
    const encoder = new TextEncoder();
    const data = encoder.encode(plain);
    return await crypto.subtle.digest("SHA-256", data);
}

function base64encode(buffer) {
    return btoa(String.fromCharCode(...new Uint8Array(buffer)))
        .replace(/=/g, "")
        .replace(/\+/g, "-")
        .replace(/\//g, "_");
}

const clientId = "b935d12c439a4d45aadd7bd1f15cf42f";
const redirectUri = "https://larsv2801.github.io/musicdisplay/";
const scopes = "user-read-currently-playing user-read-playback-state";


async function startLogin() {
    const codeVerifier = generateRandomString(64);
    const hashed = await sha256(codeVerifier);
    const codeChallenge = base64encode(hashed);

    localStorage.setItem("code_verifier", codeVerifier);

    const params = new URLSearchParams({
        response_type: "code",
        client_id: clientId,
        scope: scopes,
        redirect_uri: redirectUri,
        code_challenge_method: "S256",
        code_challenge: codeChallenge
    });

    window.location.href = "https://accounts.spotify.com/authorize?" + params;
}

// ====== Token ophalen ======
async function getToken(code) {
    const codeVerifier = localStorage.getItem("code_verifier");
    if (!codeVerifier) {
        console.error("Geen code_verifier gevonden in localStorage!");
        return;
    }

    const body = new URLSearchParams({
        client_id: clientId,
        grant_type: "authorization_code",
        code: code,
        redirect_uri: redirectUri,
        code_verifier: codeVerifier
    });

    const res = await fetch("https://accounts.spotify.com/api/token", {
        method: "POST",
        headers: { "Content-Type": "application/x-www-form-urlencoded" },
        body: body
    });

    const data = await res.json();

    if (data.access_token) {
        localStorage.setItem("access_token", data.access_token);
        getNowPlaying();
    } else {
        console.error("Fout bij ophalen token:", data);
    }
}


async function getNowPlaying() {
    const token = localStorage.getItem("access_token");
    if (!token) return;

    const res = await fetch("https://api.spotify.com/v1/me/player/currently-playing", {
        headers: { Authorization: "Bearer " + token }
    });

    if (res.status === 204) {
        document.getElementById("nowPlaying").innerText = "Er wordt niets afgespeeld.";
        return;
    }

    if (res.status === 401) {
        document.getElementById("nowPlaying").innerText = "Token ongeldig. Log opnieuw in.";
        return;
    }

    const data = await res.json();
    if (!data.item) {
        document.getElementById("nowPlaying").innerText = "Er speelt geen nummer.";
        return;
    }

    const track = data.item;
    document.getElementById("nowPlaying").innerHTML = `
        <img src="${track.album.images[0].url}" width="200"><br>
        <strong>${track.name}</strong><br>
        ${track.artists.map(a => a.name).join(", ")}<br>
        ${track.album.name}
    `;
    document.getElementById("bg").style.background = `url(${track.album.images[0].url}) center/cover no-repeat`;
    document.getElementById("bg").style.backgroundSize = `270%`;
    document.getElementById("bg").style.overflow = "hidden";
    document.getElementById("bg").style.backdropFilter = `blur(90px) brightness(0.9)`;
    document.getElementById("loginBtn").style.display = "none";
}


const params = new URLSearchParams(window.location.search);
const code = params.get("code");

if (code) {

    window.history.replaceState({}, document.title, redirectUri);
    getToken(code);
}


document.getElementById("loginBtn").addEventListener("click", startLogin);

setInterval(getNowPlaying, 5000);

</script>

</body>
</html>
